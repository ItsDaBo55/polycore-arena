const express=require("express"),http=require("http"),socketIo=require("socket.io"),app=express(),server=http.createServer(app),io=socketIo(server,{cors:{origin:"*",methods:["GET","POST"]},pingTimeout:6e4,pingInterval:25e3}),port=(app.get("/",(e,l)=>{l.send("Hello World!")}),process.env.PORT||9609),players=(server.listen(port,()=>{console.log("Server is running on "+port)}),{});let bullets=[],obstacles=[],obstacleIdCounter=0,bulletIdCounter=0;const FIELD_WIDTH=8e3,FIELD_HEIGHT=8e3,TANK_MODELS=[{name:"Dash Core",tier:0,colour:"#22d3ee",moveAccelMult:1.35,maxSpeedMult:1.3,healthMult:.8,shieldMult:.8,regenMult:1,bulletSpeedMult:1.2,bulletDamageMult:.75,bulletCount:1,bulletSpread:.12,bulletLifeMult:.9,bulletSizeMult:.8,recoilMult:1.25,bodyDamageMult:1,cooldownMult:.9,penetrationBonus:0},{name:"Bastion Shell",tier:0,colour:"#38bdf8",moveAccelMult:.75,maxSpeedMult:.75,healthMult:2,shieldMult:1.8,regenMult:1.4,bulletSpeedMult:.8,bulletDamageMult:1.4,bulletCount:1,bulletSpread:.05,bulletLifeMult:1.3,bulletSizeMult:1.3,recoilMult:3.7,bodyDamageMult:1.4,cooldownMult:5,penetrationBonus:0},{name:"Scatter Node",tier:0,colour:"#22c55e",moveAccelMult:1,maxSpeedMult:1.05,healthMult:1,shieldMult:1,regenMult:1,bulletSpeedMult:.9,bulletDamageMult:.55,bulletCount:3,bulletSpread:.45,bulletLifeMult:.85,bulletSizeMult:.85,recoilMult:1,bodyDamageMult:1,cooldownMult:1,penetrationBonus:0},{name:"Pulse Lancer",tier:1,colour:"#fb7185",moveAccelMult:1,maxSpeedMult:1.05,healthMult:1,shieldMult:.95,regenMult:.9,bulletSpeedMult:1.8,bulletDamageMult:.65,bulletCount:1,bulletSpread:.04,bulletLifeMult:.8,bulletSizeMult:1,recoilMult:1.5,bodyDamageMult:1,cooldownMult:1.25,penetrationBonus:1},{name:"Vortex Drum",tier:1,colour:"#a855f7",moveAccelMult:.95,maxSpeedMult:1,healthMult:1.1,shieldMult:1,regenMult:1,bulletSpeedMult:.85,bulletDamageMult:.42,bulletCount:9,bulletSpread:.85,bulletLifeMult:.55,bulletSizeMult:.9,recoilMult:1.3,bodyDamageMult:1.1,cooldownMult:.85,penetrationBonus:0},{name:"Rail Flare",tier:1,colour:"#f97316",moveAccelMult:.9,maxSpeedMult:.95,healthMult:.9,shieldMult:.9,regenMult:.9,bulletSpeedMult:2.5,bulletDamageMult:2,bulletCount:1,bulletSpread:.02,bulletLifeMult:1.1,bulletSizeMult:1.3,recoilMult:2,bodyDamageMult:.9,cooldownMult:1.8,penetrationBonus:1},{name:"Storm Halo",tier:2,colour:"#22c1c3",moveAccelMult:1.05,maxSpeedMult:1.05,healthMult:1.1,shieldMult:1.1,regenMult:1.1,bulletSpeedMult:1,bulletDamageMult:.9,bulletCount:5,bulletSpread:0,bulletLifeMult:1,bulletSizeMult:.95,recoilMult:1.2,bodyDamageMult:1,cooldownMult:.75,penetrationBonus:0},{name:"Guardian Orbit",tier:2,colour:"#eab308",moveAccelMult:.85,maxSpeedMult:.9,healthMult:1.9,shieldMult:2.1,regenMult:1.7,bulletSpeedMult:.7,bulletDamageMult:.8,bulletCount:8,bulletSpread:0,bulletLifeMult:1.1,bulletSizeMult:1,recoilMult:0,bodyDamageMult:1.7,cooldownMult:1.1,penetrationBonus:1},{name:"Singularity Core",tier:2,colour:"#f472b6",moveAccelMult:.9,maxSpeedMult:.9,healthMult:1.2,shieldMult:1,regenMult:1,bulletSpeedMult:.55,bulletDamageMult:2,bulletCount:1,bulletSpread:.05,bulletLifeMult:1.4,bulletSizeMult:1,recoilMult:1.7,bodyDamageMult:1.2,cooldownMult:1.6,penetrationBonus:2}],UPGRADE_MULT={bulletDamage:e=>1+.06*e,bulletSpeed:e=>1+.04*e,reload:e=>Math.pow(.88,e),speed:e=>1+.08*e,body:e=>1+.12*e,regen:e=>1+.5*e,penetration:e=>e};function getModelConfig(e){return-1==e?{name:"Basic Tank",tier:-1,colour:"#cccccc",healthMult:1,shieldMult:1,regenMult:1,moveAccelMult:1,maxSpeedMult:1,bulletCount:1,bodyDamageMult:1,cooldownMult:1,bulletSpread:0,recoilMult:1,bulletSpeedMult:1,bulletDamageMult:1,bulletLifeMult:1,bulletSizeMult:1,penetrationBonus:0}:TANK_MODELS[e]||TANK_MODELS[0]}function getBaseHealth(e){var l=getModelConfig(e.model);return(100+20*e.upgrades.health)*(l.healthMult||1)}function getBaseShield(e){var l=getModelConfig(e.model);return(100+20*e.upgrades.shield)*(l.shieldMult||1)}function randomColour(){return`hsl(${Math.floor(360*Math.random())}, 80%, 60%)`}function spawnObstacle(){var e=[{sides:3,size:30,health:40,colour:"#DAA520",outline:"#9c7616ff"},{sides:4,size:45,health:100,colour:"#1fff44ff",outline:"#15bb31ff"},{sides:5,size:70,health:400,colour:"#9370DB",outline:"#6d53a1ff"}],e=e[Math.floor(Math.random()*e.length)];obstacles.push({id:obstacleIdCounter++,x:Math.random()*(FIELD_WIDTH-e.size)+e.size/2,y:Math.random()*(FIELD_HEIGHT-e.size)+e.size/2,size:e.size,health:e.health,maxHealth:e.health,sides:e.sides,colour:e.colour,outline:e.outline,angle:0,vx:0,vy:0,flash:!1})}for(let e=0;e<330;e++)spawnObstacle();io.on("connection",v=>{players[v.id]={id:v.id,x:FIELD_WIDTH/2+400*(Math.random()-.5),y:FIELD_HEIGHT/2+400*(Math.random()-.5),angle:0,colour:randomColour(),health:100,_maxHealth:100,shield:100,_maxShield:100,xp:0,level:1,score:0,movement:{up:!1,down:!1,left:!1,right:!1},vx:0,vy:0,recoil:0,flash:0,name:"Player"+(Object.keys(players).length+1),model:-1,upgrades:{shield:0,health:0,bullet:0,speed:0,reload:0,bulletSpeed:0,bulletDamage:0,penetration:0,regen:0,body:0,multi:0,size:0},size:25,lastDamageTime:Date.now(),lastShotTime:0,immuneUntil:Date.now()+1e6,lastDamagerId:null};var e=players[v.id],l=(e.health=getBaseHealth(e),e.shield=getBaseShield(e),getModelConfig(e.model));e.colour=l.colour,v.emit("init",{id:v.id,fieldWidth:FIELD_WIDTH,fieldHeight:FIELD_HEIGHT}),v.on("movement",e=>{var l=players[v.id];l&&(l.movement=e)}),v.on("rotate",e=>{var l=players[v.id];l&&(l.angle=e)}),v.on("shoot",()=>{const d=players[v.id];if(d){var e=getModelConfig(d.model),l=(d.upgrades.reload,[.8,5,1,1.4,.7,1.6,1,1.3,4][d.model]??1),l=Math.max(120,500*l*UPGRADE_MULT.reload(d.upgrades.reload)),t=Date.now();if(!(t-d.lastShotTime<l)){d.lastShotTime=t;var l=UPGRADE_MULT.bulletSpeed(d.upgrades.bulletSpeed),a=UPGRADE_MULT.bulletDamage(d.upgrades.bulletDamage);const c=10+l,y=20+a,f=.4*d.size;d.upgrades.penetration;switch(d.model){case 0:var o=d.angle,s=.35*d.size,u=1.2*d.size,r=d.x+Math.cos(o+Math.PI/2)*s+Math.cos(o)*u,i=d.y+Math.sin(o+Math.PI/2)*s+Math.sin(o)*u,n=d.x+Math.cos(o-Math.PI/2)*s+Math.cos(o)*u,s=d.y+Math.sin(o-Math.PI/2)*s+Math.sin(o)*u;b({x:r,y:i,angle:o,speedMult:1.4,damageMult:.8,life:60,sizeMult:.7,penBonus:0,type:"needle"}),b({x:n,y:s,angle:o,speedMult:1.4,damageMult:.8,life:60,sizeMult:.7,penBonus:0,type:"needle"}),d.recoil=6;break;case 1:b({angle:d.angle,speedMult:.6,damageMult:5,life:260,sizeMult:2,penBonus:1,type:"shell"}),d.recoil=8;break;case 2:var M=Math.PI/6;for(let e=-1;e<=1;e++)b({angle:d.angle+e*M,speedMult:.9,damageMult:.8,life:200,sizeMult:.9,type:"shard"});d.recoil=7;break;case 3:for(let e=0;e<4;e++)b({angle:d.angle+.02*(Math.random()-.5),speedMult:2.2,damageMult:.6,life:80,sizeMult:1,penBonus:2,type:"beam"});d.recoil=10;break;case 4:var h=.6*Math.PI;for(let e=0;e<9;e++){var p=e/8-.5;b({angle:d.angle+p*h+.15*(Math.random()-.5),speedMult:.8,damageMult:.35,life:120,sizeMult:.7,type:"pellet"})}d.recoil=5;break;case 5:b({angle:d.angle,speedMult:3,damageMult:2,life:260,sizeMult:1.2,penBonus:2,type:"rail"}),d.recoil=14;break;case 6:var m=.4*Math.PI;for(let e=0;e<5;e++){var g=e/4-.5;b({angle:d.angle+g*m,speedMult:1.1,damageMult:.9,life:200,sizeMult:.9,type:"arc"})}d.recoil=2;break;case 7:for(let e=0;e<8;e++)b({angle:d.angle+e/8*Math.PI*2,speedMult:.7,damageMult:.75,life:140,sizeMult:.9,penBonus:1,type:"pulse"});d.recoil=0;break;case 8:b({angle:d.angle,speedMult:.5,damageMult:2.4,life:340,sizeMult:1.6,penBonus:3,type:"orb"}),d.recoil=11;break;default:b({angle:d.angle}),d.recoil=8}d.immuneUntil=t;l=.05*c*e.recoilMult;function b(e){var l=getModelConfig(d.model),t=e.angle+(Math.random()-.5)*l.bulletSpread,a=c*(e.speedMult??1)*l.bulletSpeedMult*UPGRADE_MULT.bulletSpeed(d.upgrades.bulletSpeed),o=y*(e.damageMult??1)*l.bulletDamageMult*UPGRADE_MULT.bulletDamage(d.upgrades.bulletDamage),s=f*(e.sizeMult??1)*l.bulletSizeMult,u=(e.life??200)*l.bulletLifeMult,r=UPGRADE_MULT.penetration(d.upgrades.penetration)+(e.penBonus??0)+l.penetrationBonus,i=e.x??d.x,n=e.y??d.y;bullets.push({id:bulletIdCounter++,x:i,y:n,dx:Math.cos(t)*a,dy:Math.sin(t)*a,owner:v.id,ownerModel:d.model,damage:o,life:u,size:s,penetration:r,type:e.type||"normal"}),d.recoil+=(e.recoil??5)*l.recoilMult}d.vx-=Math.cos(d.angle)*l,d.vy-=Math.sin(d.angle)*l}}}),v.on("disconnect",()=>{delete players[v.id]}),v.on("setName",e=>{var l=players[v.id];l&&"string"==typeof e&&0<e.trim().length&&(l.name=e.trim().substring(0,16))}),v.on("upgrade",e=>{var l,t=players[v.id];t&&["shield","health","speed","regen","body","bulletSpeed","bulletDamage","reload","penetration"].includes(e)&&(l=t.upgrades.shield+t.upgrades.health+t.upgrades.speed+t.upgrades.regen+t.upgrades.body+t.upgrades.bulletSpeed+t.upgrades.bulletDamage+t.upgrades.reload+t.upgrades.penetration,t.level-1<=l||10<=t.upgrades[e]||(t.upgrades[e]+=1,"health"===e?(l=getBaseHealth(t),t._maxHealth=l):"shield"===e&&(l=getBaseShield(t),t._maxShield=l)))}),v.on("setModel",e=>{var l,t,a,o=players[v.id];o&&"number"==typeof e&&((e=e<0?-1:e)>TANK_MODELS.length-1&&(e=TANK_MODELS.length-1),o.model=e,e=getModelConfig(o.model),o.colour=e.colour,e=o._maxHealth||getBaseHealth({...o,model:-1}),a=o._maxShield||getBaseShield({...o,model:-1}),l=getBaseHealth(o),t=getBaseShield(o),e=e?o.health/e:1,a=a?o.shield/a:1,o.health=Math.max(10,l*Math.max(.3,Math.min(e,1))),o.shield=Math.max(10,t*Math.max(.3,Math.min(a,1))),o._maxHealth=l,o._maxShield=t)})});const PHYSICS_TICK=1e3/60,STATE_TICK=1e3/30,FRICTION=.9,PLAYER_FRICTION=.9,FIELD_MIN=400,FIELD_MAX=7600,BULLET_MARGIN=50;let logicTick=0;function fastRemove(e,l,t=!1){if(t){const t=e[l];io.sockets.emit("bulletDeath",{x:t.x,y:t.y,size:t.size,owner:t.owner})}e[l]=e[e.length-1],e.pop()}function spawnExplosion(l,t,a,o,s){var u=Date.now();for(const e in players){var r=players[e];if(r.id!=s.owner){var i=r.x-l,n=r.y-t;if(i*i+n*n<a*a){let e=o;0<r.shield&&(i=Math.min(r.shield,e),r.shield-=i,e-=i),0<e&&(n=e*UPGRADE_MULT.bulletDamage(players[s.owner]?.upgrades.bulletDamage||0),r.health-=n),r.lastDamageTime=u,r.lastDamagerId=s.owner,0<r.health&&(r.flash=3)}}}for(let e=obstacles.length-1;0<=e;e--){var d=obstacles[e],M=d.x-l,h=d.y-t;M*M+h*h<a*a&&(d.health-=o,d.health<=0?((M=players[s.owner])&&(h=100*d.maxHealth,M.score+=h,M.xp+=h),io.sockets.emit("entityDeath",{x:d.x,y:d.y,size:1.5*d.size,color:d.colour}),fastRemove(obstacles,e),spawnObstacle()):e.flash=3)}fastRemove(bullets,bullets.indexOf(s),!0),io.sockets.emit("explosion",{x:l,y:t,radius:.9*a})}setInterval(()=>{var a=Date.now(),o=(logicTick++,Object.keys(players)),s=o.length;obstacles.length;for(let t=0;t<s;t++){var u=o[t],u=players[u];let e=(u.movement.right?1:0)-(u.movement.left?1:0),l=(u.movement.down?1:0)-(u.movement.up?1:0);(e||l)&&(r=1/Math.sqrt(e*e+l*l),e*=r,l*=r,u.immuneUntil=a);var r=getModelConfig(u.model),i=.5*(r.moveAccelMult||1)*UPGRADE_MULT.speed(u.upgrades.speed),i=(u.vx=u.vx*PLAYER_FRICTION+e*i,u.vy=u.vy*PLAYER_FRICTION+l*i,(6+.1*u.level)*(r.maxSpeedMult||1)*UPGRADE_MULT.speed(u.upgrades.speed)),P=u.vx*u.vx+u.vy*u.vy;i*i<P&&(i=i/Math.sqrt(P),u.vx*=i,u.vy*=i),u.x+=u.vx,u.y+=u.vy,u.x<FIELD_MIN?u.x=FIELD_MIN:u.x>FIELD_MAX&&(u.x=FIELD_MAX),u.y<FIELD_MIN?u.y=FIELD_MIN:u.y>FIELD_MAX&&(u.y=FIELD_MAX)}for(let l=bullets.length-1;0<=l;l--){var t=bullets[l],F=getModelConfig(players[t.owner].model||-1);if(t.x+=t.dx,t.y+=t.dy,--t.life<=0||t.x<-BULLET_MARGIN||t.x>FIELD_WIDTH+BULLET_MARGIN||t.y<-BULLET_MARGIN||t.y>FIELD_HEIGHT+BULLET_MARGIN)"orb"===t.type?spawnExplosion(t.x,t.y,8*t.size,3*t.damage,t):fastRemove(bullets,l,!0);else{--t.life;var H=t.x,G=t.y;for(let e=obstacles.length-1;0<=e;e--){var n=obstacles[e],d=H-n.x,k=G-n.y,N=d*d+k*k,M=.5*n.size+4;if(N<M*M){var M=t.damage*UPGRADE_MULT.bulletDamage(players[t.owner]?.upgrades.bulletDamage||0),M=(n.health-=M,1/Math.sqrt(N)),N=.05*UPGRADE_MULT.bulletSpeed(players[t.owner]?.upgrades.bulletSpeed||0)*F.bulletSpeedMult;n.vx+=d*M*t.dx*N*(d<0?-1:1),n.vy+=k*M*t.dy*N*(k<0?-1:1),n.health<=0?((d=players[t.owner])&&(M=+n.maxHealth,d.score+=M,d.xp+=M),io.sockets.emit("entityDeath",{x:n.x,y:n.y,size:1.5*n.size,color:n.colour}),fastRemove(obstacles,e),spawnObstacle(),"orb"===t.type?spawnExplosion(t.x,t.y,8*t.size,3*t.damage,t):0<t.penetration?t.penetration--:fastRemove(bullets,l,!0)):"orb"===t.type?spawnExplosion(t.x,t.y,8*t.size,3*t.damage,t):(fastRemove(bullets,l,!0),n.flash=3);break}}for(let e=0;e<s;e++){var h=o[e];if(h!==t.owner){h=players[h];if(!(a<h.immuneUntil)){var O=H-h.x,q=G-h.y,p=O*O+q*q,m=(h.size||20)+4;if(p<m*m){if("orb"===t.type)spawnExplosion(t.x,t.y,8*t.size,3*t.damage,t);else{let e=t.damage;0<h.shield&&(m=Math.min(h.shield,e),h.shield-=m,e-=m),0<e&&(m=e*UPGRADE_MULT.bulletDamage(players[t.owner]?.upgrades.bulletDamage||0),h.health-=m),0<h.health?(fastRemove(bullets,l,!0),h.flash=3):0<t.penetration?t.penetration--:fastRemove(bullets,l,!0),h.lastDamageTime=a,h.lastDamagerId=t.owner}m=1/Math.sqrt(p),p=.15*UPGRADE_MULT.bulletSpeed(players[t.owner]?.upgrades.bulletSpeed||0)*F.bulletSpeedMult;h.vx+=O*m*t.dx*p*(O<0?-1:1),h.vy+=q*m*t.dy*p*(q<0?-1:1);break}}}}}}if(0==(3&logicTick))for(let l=0;l<bullets.length;l++){var g=bullets[l];for(let e=l+1;e<bullets.length;e++){var b=bullets[e];if(g.owner!==b.owner){var K=getModelConfig(players[g.owner].model||-1),X=getModelConfig(players[b.owner].model||-1),c=g.x-b.x,W=g.y-b.y,y=c*c+W*W,f=g.size+b.size;if(y<f*f){var f=players[g.owner],Y=players[b.owner],y=(f?.upgrades?.bulletSpeed,Y?.upgrades?.bulletSpeed,0<y?1/Math.sqrt(y):0),c=c*y,W=W*y;if(!(0<g.penetration)){fastRemove(bullets,l,!0),l--;break}if(g.penetration--,0<b.penetration){b.penetration--;y=5*UPGRADE_MULT.bulletDamage(f?.upgrades.bulletDamage||0)*K.bulletDamageMult,f=5*UPGRADE_MULT.bulletDamage(Y?.upgrades.bulletDamage||0)*X.bulletDamageMult;if(g.damage-=5+f,b.damage-=5+y,g.damage<=0){fastRemove(bullets,l,!0),l--;break}b.damage<=0?(fastRemove(bullets,e,!0),e--):(K=g.dx,Y=g.dy,X=b.dx,f=b.dy,g.dx=K-.15*c,g.dy=Y-.15*W,b.dx=X+.15*c,b.dy=f+.15*W)}else fastRemove(bullets,e,!0),e--}}}}for(let e=0;e<obstacles.length;e++){var l=obstacles[e],j=(0<l.flash&&l.flash--,l.timeFactor=(l.timeFactor||1e3*Math.random())+.01,Math.sin(.5*l.timeFactor)),V=Math.cos(.5*l.timeFactor),j=(l.vx=.98*(l.vx+.005*j),l.vy=.98*(l.vy+.005*V),l.vx*l.vx+l.vy*l.vy);144<j&&(V=12/Math.sqrt(j),l.vx*=V,l.vy*=V),l.x+=l.vx,l.y+=l.vy,3==l.sides?l.angle+=360/54e3:4==l.sides?l.angle+=360/63e3:5==l.sides&&(l.angle+=.004),360<=l.angle&&(l.angle=0),l.x<FIELD_MIN?l.x=FIELD_MIN:l.x>FIELD_MAX&&(l.x=FIELD_MAX),l.y<FIELD_MIN?l.y=FIELD_MIN:l.y>FIELD_MAX&&(l.y=FIELD_MAX)}for(let e=0;e<s;e++){var v=players[o[e]],$=a<v.immuneUntil;for(let e=obstacles.length-1;0<=e;e--){var D=obstacles[e],J=v.x-D.x,Q=v.y-D.y,x=J*J+Q*Q,I=(v.size||20)+D.size/2;if(x<I*I){var S=10*(getModelConfig(v.model).bodyDamageMult||1)*UPGRADE_MULT.body(v.upgrades.body);if(D.health-=S,!$){let e=5;0<v.shield&&(S=Math.min(v.shield,e),v.shield-=S,e-=S),0<e&&(v.health-=e),v.lastDamageTime=a,0<v.health&&(v.flash=3)}var S=Math.sqrt(x),x=I-S,I=.05*(3===D.sides?5:4===D.sides?7:10),J=J/S*x*I,Q=Q/S*x*I,S=UPGRADE_MULT.speed(v.upgrades.speed);v.vx+=J*S,v.vy+=Q*S,D.vx-=J*S*.4,D.vy-=Q*S*.4,D.health<=0?(x=+D.maxHealth,(I=v).score+=x,I.xp+=x,io.sockets.emit("entityDeath",{x:D.x,y:D.y,size:1.5*D.size,color:D.colour}),fastRemove(obstacles,e),spawnObstacle()):D.flash=3}}}for(let l=0;l<s;l++){var L=players[o[l]];for(let e=l+1;e<s;e++){var E=players[o[e]],_=L.x-E.x,T=L.y-E.y,Z=_*_+T*T,z=(L.size||20)+(E.size||20);if(Z<z*z){var A=a<L.immuneUntil,U=a<E.immuneUntil;if(!A){let e=10*(getModelConfig(E.model).bodyDamageMult||1)*UPGRADE_MULT.body(E.upgrades.body);0<L.shield&&(A=Math.min(L.shield,e),L.shield-=A,e-=A),0<e&&(L.health-=e),L.lastDamageTime=a,0<L.health&&(L.flash=3)}if(!U){let e=10*(getModelConfig(L.model).bodyDamageMult||1)*UPGRADE_MULT.body(L.upgrades.body);0<E.shield&&(A=Math.min(E.shield,e),E.shield-=A,e-=A),0<e&&(E.health-=e),E.lastDamageTime=a,0<E.health&&(E.flash=3)}U=Math.sqrt(Z),A=z-U,Z=1/U,z=_*Z*(.5*A),U=T*Z*(.5*A),_=UPGRADE_MULT.speed(L?.upgrades.speed||1),T=UPGRADE_MULT.speed(E?.upgrades.speed||1);L.vx+=.5*z*_,L.vy+=.5*U*_,E.vx-=.5*z*T,E.vy-=.5*U*T}}}for(let l=0;l<obstacles.length;l++){var ee=obstacles[l];for(let e=l+1;e<obstacles.length;e++){var le=obstacles[e],te=ee.x-le.x,w=ee.y-le.y,ae=te*te+w*w,oe=.5*ee.size+.5*le.size;ae<oe*oe&&(w=w*(ae=0<(w=Math.sqrt(ae))?1/w:0)*(.5*(oe=oe-w)),ee.vx+=.5*(te=te*ae*(.5*oe)),ee.vy+=.5*w,le.vx-=.5*te,le.vy-=.5*w)}}for(let e=0;e<s;e++){var R=players[o[e]];for(R.size=20+.28*R.level;R.level<45;){var se=100+50*Math.pow(R.level,1.5);if(R.xp<se)break;R.xp-=se,R.level++}}for(const Me in players){var ue,re,e,C=players[Me];0<C.recoil&&(C.recoil-=.5),0<C.flash&&C.flash--,C.health<=0&&(io.sockets.emit("entityDeath",{x:C.x,y:C.y,size:2*C.size,color:C.colour}),(e=players[C.lastDamagerId])&&(ue=Math.min(C.score,25e3),e.score+=ue,e.xp+=200,C.score-=ue),ue=Math.max(1,Math.floor(C.level/2)),C.level=ue,C.xp=0,C.score=0,C.model=-1,C.health=getBaseHealth(C),C.shield=getBaseShield(C),re=getModelConfig(C.model),C.colour=re.colour,C.x=FIELD_WIDTH/2+400*(Math.random()-.5),C.y=FIELD_HEIGHT/2+400*(Math.random()-.5),C.vx=0,C.vy=0,C.immuneUntil=Date.now()+1e4,C.lastDamagerId=null,C.movement={up:!1,down:!1,left:!1,right:!1},C.recoil=0,C.flash=0,C.upgrades={shield:0,health:0,bullet:0,speed:0,reload:0,bulletSpeed:0,bulletDamage:0,penetration:0,regen:0,body:0,multi:0,size:0},C.size=25,re=io.sockets.sockets.get(Me))&&(C=e?e.name:"Unknown",e=e?e.id:null,re.emit("death",{killer:C,killerId:e}))}for(let e=0;e<s;e++){var B=players[o[e]],ie=getModelConfig(B.model),ne=getBaseHealth(B),de=getBaseShield(B),ie=UPGRADE_MULT.regen(B.upgrades.regen)*ie.regenMult;B.health<ne&&a-B.lastDamageTime>3e3/ie&&(B.health+=5/30*ie),B.shield<de&&(B.shield+=2/30*ie)}},PHYSICS_TICK),setInterval(()=>{io.sockets.emit("state",{players:players,bullets:bullets,obstacles:obstacles,walls:[]})},STATE_TICK);